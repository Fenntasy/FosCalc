<!DOCTYPE html manifest="foscalc.appcache">
<html>
<head>
    <title></title>
    <link rel="stylesheet" href="css/main.css" />
    <meta charset="utf-8"/>
</head>
<body>
    <section id="calculator">
        <header id="screen-container">
            <div id="screen">
                <button id="install">
                    Install this awesome app on your homescreen!
                </button>
                <div id="screen-text">
                </div>
            </div>
        </header>
        <table>
            <tr>
                <td colspan=2>
                    <div class="button double-width"><div class="content">clear</div></div>
                </td>
                <td>
                    <div class="button"><div class="content">←</div></div>
                </td>
                <td>
                    <div class="button"><div class="content">/</div></div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="button"><div class="content">7</div></div>
                </td>
                <td>
                    <div class="button"><div class="content">8</div></div>
                </td>
                <td>
                    <div class="button"><div class="content">9</div></div>
                </td>
                <td>
                    <div class="button"><div class="content">*</div></div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="button"><div class="content">4</div></div>
                </td>
                <td>
                    <div class="button"><div class="content">5</div></div>
                </td>
                <td>
                    <div class="button"><div class="content">6</div></div>
                </td>
                <td>
                    <div class="button"><div class="content">-</div></div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="button"><div class="content">1</div></div>
                </td>
                <td>
                    <div class="button"><div class="content">2</div></div>
                </td>
                <td>
                    <div class="button"><div class="content">3</div></div>
                </td>
                <td>
                    <div class="button"><div class="content">+</div></div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="button"><div class="content">0</div></div>
                </td>
                <td>
                    <div class="button"><div class="content">.</div></div>
                </td>
                <td colspan=2>
                    <div class="button double-width"><div class="content">=</div></div>
                </td>
            </tr>
        </table>
    </section>
    <script>
        (function(){
            // get a reference to the button and call install() on click
            var button = document.getElementById('install');

            var buttons = document.getElementsByClassName('button');
            var screen_container = document.getElementById('screen');
            var screen = document.getElementById('screen-text');
            var calc = '';
            var font_size = 5;
            var buttonClicked = function() {
                button.style.display = "none";
                var item = this.children.item(0).innerHTML;
                switch(item) {
                    case '=':
                        if (calc) {
                            calc = eval(calc);
                        }
                        screen_container.style.fontSize = font_size + 'em';
                        break;
                    case 'clear':
                        calc = '';
                        font_size = 5;
                        break;
                    case '←':
                        calc = calc.substr(0, calc.length - 1);
                        break;
                    default:
                        calc += item;
                        break;
                }
                screen.innerHTML = calc;
                if (screen_container.offsetWidth < screen.offsetWidth && font_size > 1) {
                    screen_container.style.fontSize = --font_size + 'em';
                }
            }
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].addEventListener('touchend', buttonClicked, false);
//                buttons[i].addEventListener('click', buttonClicked, false);
            }
            button.addEventListener('click', install, false);

            var request = navigator.mozApps.checkInstalled("http://vincent.billey.me/foscalc/manifest.webapp");
            request.onsuccess = function() {
                if (request.result) {
                    // we're installed
                    button.style.display = "none";
                } else {
                    // not installed
                    button.style.display = "show";
                }
            };
            request.onerror = function() {
                alert('Error checking installation status: ' + this.error.message);
            };

            function install(ev) {
                ev.preventDefault();
                // define the manifest URL
                var manifest_url = "http://vincent.billey.me/foscalc/manifest.webapp";
                // install the app
                var myapp = navigator.mozApps.install(manifest_url);
                myapp.onsuccess = function(data) {
                    // App is installed, remove button
                    this.parentNode.removeChild(this);
                };
                myapp.onerror = function() {
                    // App wasn't installed, info is in
                    // installapp.error.name
                    alert(myapp.error.name);
                };
            };
        })();
    </script>
</body>
</html>